<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Design/Design Decisions">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Design Decisions | Auticuro</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://financial_platform.pages.awx.im/Auticuro/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://financial_platform.pages.awx.im/Auticuro/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Design Decisions"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Design Decisions | Auticuro"><meta data-rh="true" name="description" content="Auticuro can serve as the cornerstone for mission-critical financial applications. To further illustrate this point, the following high-level architecture showcases how Auticuro can be utilized to build a distributed wallet service and highlights its role within the overall system&#x27;s ecosystem. In order to provide a comprehensive understanding of the architecture, we will also outline the most significant design decisions."><meta data-rh="true" property="og:description" content="Auticuro can serve as the cornerstone for mission-critical financial applications. To further illustrate this point, the following high-level architecture showcases how Auticuro can be utilized to build a distributed wallet service and highlights its role within the overall system&#x27;s ecosystem. In order to provide a comprehensive understanding of the architecture, we will also outline the most significant design decisions."><link data-rh="true" rel="icon" href="/Auticuro/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Design Decisions"><link data-rh="true" rel="alternate" href="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Design Decisions" hreflang="en"><link data-rh="true" rel="alternate" href="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Design Decisions" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/Auticuro/blog/rss.xml" title="Auticuro RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Auticuro/blog/atom.xml" title="Auticuro Atom Feed"><link rel="stylesheet" href="/Auticuro/assets/css/styles.6dc9aec6.css">
<link rel="preload" href="/Auticuro/assets/js/runtime~main.db8b443a.js" as="script">
<link rel="preload" href="/Auticuro/assets/js/main.e77f3fff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Auticuro/"><div class="navbar__logo"><img src="/Auticuro/img/logo.svg" alt="Auticuro Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/Auticuro/img/logo.svg" alt="Auticuro Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Auticuro</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Auticuro/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/Auticuro/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/airwallex/Auticuro" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Source<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/intro">Auticuro Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/Auticuro/docs/category/introduction">Introduction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Introduction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/Quick Start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/Auticuro/docs/category/design">Design</a><button aria-label="Toggle the collapsible sidebar category &#x27;Design&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Auticuro/docs/Design/Design Decisions">Design Decisions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Auticuro/docs/Design/Architecture Overview">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Auticuro/docs/Design/Command Side">Command Side</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Auticuro/docs/Design/QuerySide">Query Side</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/Auticuro/docs/category/dependability">Dependability</a><button aria-label="Toggle the collapsible sidebar category &#x27;Dependability&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/Auticuro/docs/category/api-doc">API Doc</a><button aria-label="Toggle the collapsible sidebar category &#x27;API Doc&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/FAQ">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/Auticuro/docs/category/evaluation">Evaluation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Evaluation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/ReleaseNotes">Release Notes</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Auticuro/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/Auticuro/docs/category/design"><span itemprop="name">Design</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Design Decisions</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Design Decisions</h1><p>Auticuro can serve as the cornerstone for mission-critical financial applications. To further illustrate this point, the following high-level architecture showcases how Auticuro can be utilized to build a distributed wallet service and highlights its role within the overall system&#x27;s ecosystem. In order to provide a comprehensive understanding of the architecture, we will also outline the most significant design decisions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-of-a-distributed-wallet-service">Architecture of A Distributed Wallet Service<a href="#architecture-of-a-distributed-wallet-service" class="hash-link" aria-label="Direct link to Architecture of A Distributed Wallet Service" title="Direct link to Architecture of A Distributed Wallet Service">​</a></h2><p>As depicted in the following diagram, the distributed wallet service is divided into three layers:</p><p><img loading="lazy" alt="image info" src="/Auticuro/assets/images/High_level_architecture-3817d0d4cf553f9ff60f7bc9bef43eb6.svg" width="520" height="340" class="img_ev3q"></p><ul><li><strong>Access Layer</strong> that translates incoming flexible business requests into underlying stationary
account operations,</li><li><strong>Transaction Layer</strong>, a.k.a. Marker, that orchestrates cross-shard money movements with ACID
guarantees, where ACID refers to the four key properties of a transaction: atomicity, consistency, isolation, and durability.</li><li><strong>Storage Layer</strong>, a.k.a. Auticuro, that supports low-level, high-performance atomic account
operations within a single shard.</li></ul><p>Shards within the same layer do not communicate, while shards from different layers are fully connected. For example, Replicas in Access Layer can talk with any shard from the Transaction Layer or Storage Layer, and shards in the Transaction Layer can talk with any shard from Storage Layer.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decouple-transaction-layer-and-storage-layer">Decouple Transaction Layer and Storage Layer<a href="#decouple-transaction-layer-and-storage-layer" class="hash-link" aria-label="Direct link to Decouple Transaction Layer and Storage Layer" title="Direct link to Decouple Transaction Layer and Storage Layer">​</a></h2><p>The most important design decision we made was to decouple the transaction layer and storage layer. The decoupling dramatically decreases the engineering complexity and maintenance overhead while increasing the performance of transaction management and account operations.</p><p>The transaction layer is computation-intensive, while the storage layer is data-intensive. The transaction layer should be scaled up and down according to the traffic volume, while the storage layer should be scaled up according to the number of accounts. A new shard in the transaction layer can be brought up when encountering traffic spikes and decommissioned as long as it has no ongoing transactions.</p><p>A shard in the storage layer with a naive single-threaded implementation could easily achieve more than 20,000 account operations per second. In contrast, a carefully designed and implemented shard in the transaction layer can schedule 2,000 transactions per second.</p><p>According to our prior experience, a monolithic solution is hard to implement and evolve and much slower than the decoupled solution since it needs to handle quite a few complex situations relating to the pending conditional transfer due to the coupling of transaction management and account operation. It is also hard to smoothly scale up and down when encountering traffic spikes since it needs to repartition the accounts while scaling up and repartition again while scaling down, which is quite a burden for maintenance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decouple-flex-and-stationary">Decouple Flex and Stationary<a href="#decouple-flex-and-stationary" class="hash-link" aria-label="Direct link to Decouple Flex and Stationary" title="Direct link to Decouple Flex and Stationary">​</a></h2><p>The wallet service separates the fundamental balance operation APIs from the business-facing APIs, the former is implemented in the storage layer, and the latter is implemented in the access layer. It offers several benefits:</p><ul><li>Independent Scalability: Decoupling the layers allows the scale of each layer independently based on its specific requirements. The fundamental balance operation APIs are stable and should be changed conservatively, while the business-facing APIs need to evolve quickly to adapt to the business requirements.</li><li>Easier to test and debug: Separating the core balance operation APIs from the business-facing APIs makes it simpler to test and debug each layer independently, ensuring a more robust and reliable system.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decouple-read-and-write---cqrs-with-event-sourcing">Decouple Read and Write - CQRS with Event Sourcing<a href="#decouple-read-and-write---cqrs-with-event-sourcing" class="hash-link" aria-label="Direct link to Decouple Read and Write - CQRS with Event Sourcing" title="Direct link to Decouple Read and Write - CQRS with Event Sourcing">​</a></h2><p>Command and Query Responsibility Segregation(CQRS) means separating reads and writes into different models, using commands to update data and queries to read data. Commands represent actions to change the state of the system. Usually, we refer to the command as the write operation. We would prefer the use of command and will use it throughout this document. You can think they are the synonym of the write operations. Benefits of CQRS include:</p><ul><li>Independent scaling. CQRS allows the read and write workloads to scale independently and results in fewer lock contentions.</li><li>Optimized data schemas. The query side can use a schema optimized for queries, while the command side uses a schema optimized for updates.</li><li>Separation of concerns. Segregating the command and query sides can result in models that are more maintainable and flexible. Additionally, the command and query sides could have different optimization and scaling solutions.</li></ul><p>Instead of storing just the current state of the data in a domain, in Event Sourcing, an append-only store is used to record the full series of actions taken on that data. The store acts as the golden source, and the records can be used to materialize the domain objects.</p><p>Marker and Auticuro follow the CQRS pattern with Event Sourcing, each shard of which is separated into the command side and query side, connected by an event store. Only the most critical logic, such as real-time balance check, is processed on the command side. Others are processed on the query side, tailored for query performance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decouple-account-structure-and-storage">Decouple Account Structure and Storage<a href="#decouple-account-structure-and-storage" class="hash-link" aria-label="Direct link to Decouple Account Structure and Storage" title="Direct link to Decouple Account Structure and Storage">​</a></h2><p>The wallet service supports account hierarchy, a tree-like structure where an account can have a bunch of sub-accounts, and the account&#x27;s balance is the total balance of its sub-accounts.</p><ul><li>Money movements are only allowed on the leaf accounts</li><li>Balance queries of all accounts(leaf account + non-leaf accounts) are supported.</li></ul><p>We decouple the two functionalities with CQRS methodology, putting the leaf account storage model on the command(write) side and the account hierarchy models on the query side because these two models are orthogonal. In this way, they can scale or adapt to business change independently.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="correctness-dependability-and-performance">Correctness, Dependability, and Performance<a href="#correctness-dependability-and-performance" class="hash-link" aria-label="Direct link to Correctness, Dependability, and Performance" title="Direct link to Correctness, Dependability, and Performance">​</a></h2><p>The wallet service is implemented in the Rust programming language to achieve correctness and performance. Rust’s rich type system and ownership model guarantee memory safety and thread safety. Rust is blazingly fast and memory efficient: with no runtime or garbage collector, powering performance-critical services.</p><p>The wallet service employs a single-threaded, lockless critical path to reduce contention, improve throughput, and reduce latency. This choice dramatically reduces the engineering complexity as error-prone multi-threaded code is discarded without hurting the performance.</p><p>The command side of Marker and Auticuro is built on top of the <a href="https://raft.github.io/" target="_blank" rel="noopener noreferrer">Raft algorithm</a>, leveraging Raft to achieve strong consistency and high availability. Raft is a consensus algorithm, which is a protocol used in distributed systems to achieve agreement among multiple nodes on a specific value or state, even in the presence of failures. Raft achieves consensus via an elected leader. A server in a raft cluster is either a leader or a follower and can be a candidate in the precise case of an election (leader unavailable). The leader is responsible for log replication to the followers.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/Auticuro/docs/category/design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Design</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Auticuro/docs/Design/Architecture Overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Architecture</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture-of-a-distributed-wallet-service" class="table-of-contents__link toc-highlight">Architecture of A Distributed Wallet Service</a></li><li><a href="#decouple-transaction-layer-and-storage-layer" class="table-of-contents__link toc-highlight">Decouple Transaction Layer and Storage Layer</a></li><li><a href="#decouple-flex-and-stationary" class="table-of-contents__link toc-highlight">Decouple Flex and Stationary</a></li><li><a href="#decouple-read-and-write---cqrs-with-event-sourcing" class="table-of-contents__link toc-highlight">Decouple Read and Write - CQRS with Event Sourcing</a></li><li><a href="#decouple-account-structure-and-storage" class="table-of-contents__link toc-highlight">Decouple Account Structure and Storage</a></li><li><a href="#correctness-dependability-and-performance" class="table-of-contents__link toc-highlight">Correctness, Dependability, and Performance</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Auticuro, Airwallex. Built with Docusaurus.</div></div></div></footer></div>
<script src="/Auticuro/assets/js/runtime~main.db8b443a.js"></script>
<script src="/Auticuro/assets/js/main.e77f3fff.js"></script>
</body>
</html>
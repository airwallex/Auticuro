<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Design/Architecture Overview">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Architecture | Auticuro</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://financial_platform.pages.awx.im/Auticuro/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://financial_platform.pages.awx.im/Auticuro/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Architecture Overview"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture | Auticuro"><meta data-rh="true" name="description" content="image info"><meta data-rh="true" property="og:description" content="image info"><link data-rh="true" rel="icon" href="/Auticuro/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Architecture Overview"><link data-rh="true" rel="alternate" href="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Architecture Overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://financial_platform.pages.awx.im/Auticuro/docs/Design/Architecture Overview" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/Auticuro/blog/rss.xml" title="Auticuro RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Auticuro/blog/atom.xml" title="Auticuro Atom Feed"><link rel="stylesheet" href="/Auticuro/assets/css/styles.6dc9aec6.css">
<link rel="preload" href="/Auticuro/assets/js/runtime~main.db8b443a.js" as="script">
<link rel="preload" href="/Auticuro/assets/js/main.e77f3fff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Auticuro/"><div class="navbar__logo"><img src="/Auticuro/img/logo.svg" alt="Auticuro Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/Auticuro/img/logo.svg" alt="Auticuro Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Auticuro</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Auticuro/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/Auticuro/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/airwallex/Auticuro" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Source<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/intro">Auticuro Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/Auticuro/docs/category/introduction">Introduction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Introduction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/Quick Start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/Auticuro/docs/category/design">Design</a><button aria-label="Toggle the collapsible sidebar category &#x27;Design&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Auticuro/docs/Design/Design Decisions">Design Decisions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Auticuro/docs/Design/Architecture Overview">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Auticuro/docs/Design/Command Side">Command Side</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Auticuro/docs/Design/QuerySide">Query Side</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/Auticuro/docs/category/dependability">Dependability</a><button aria-label="Toggle the collapsible sidebar category &#x27;Dependability&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/Auticuro/docs/category/api-doc">API Doc</a><button aria-label="Toggle the collapsible sidebar category &#x27;API Doc&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/FAQ">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/Auticuro/docs/category/evaluation">Evaluation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Evaluation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Auticuro/docs/ReleaseNotes">Release Notes</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Auticuro/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/Auticuro/docs/category/design"><span itemprop="name">Design</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Architecture</h1><p><img loading="lazy" alt="image info" src="/Auticuro/assets/images/CQRS_with_event_sourcing-0a33ba2e56411590867cae3556b9edf7.svg" width="1020" height="601" class="img_ev3q">
Above is the high-level architecture of one Auticuro shard, which uses CQRS with Event Sourcing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="command-side">Command Side<a href="#command-side" class="hash-link" aria-label="Direct link to Command Side" title="Direct link to Command Side">​</a></h2><p>The command side of the Auticuro shard is written in Rust to achieve high performance and correctness
and uses Raft to achieve dependability under cloud environments. It processes requests for account
management and balance operation, supports real-time balance checks in critical-path, and generates
event logs streamed to the query side in a real-time manner.</p><p>Auticuro leverages its single-threaded critical path and Copy-On-Write pattern to achieve all-or-nothing
semantics for a batch of operations. If any of the operations in a batch fails due to balance limitation
checks or improper account state, the preceding changes made by that batch on cloned accounts are discarded,
leaving the state unchanged.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="query-side">Query Side<a href="#query-side" class="hash-link" aria-label="Direct link to Query Side" title="Direct link to Query Side">​</a></h2><p>The query side provides materialized views of the accounts by replaying event logs tailored to flexible
business requirements to maximize the query performance. These views are read-only caches of the events,
while the event store is the golden source of truth. It is essential that the command side generates events
with a consecutive sequence number, which can be used by query sides to perform integrity checks and
detect missing or out-of-order events. When the query side system is damaged, its state can be
restored by replaying all past account/balance change events, and snapshots are used to accelerate
the process. Typical query side services are as follows:</p><p><strong>Account Hierarchy Service</strong></p><p>Our client could set up multiple accounts for a specific business requirement and organize them as
a tree-style hierarchy. Leaf accounts support modifications such as account management and balance
operations, while non-leaf accounts are unmodifiable and illustrate an aggregated read-only view.</p><p>An Account Hierarchy Service is built to satisfy the above requirement:</p><ul><li>The Account Hierarchy Service applies events and calculates leaf accounts&#x27; balance </li><li>Users could CRUD account hierarchy configs via the UI, where CRUD is the acronym for CREATE, READ,
UPDATE, and DELETE. </li><li>When receiving a query request, the Account Hierarchy Service reads the account hierarchy config
from the database and calculates the non-leaf account&#x27;s balance by aggregating the balance of
its children recursively.</li></ul><p><strong>Account Query Service</strong></p><p>The Account Query Service provides the Read-Your-Write consistency query for account balances and
balance change history.  After you&#x27;ve updated the account, it is very natural that if you immediately
read it back, you should read your last modification. This is called read-your-write consistency.
It is desirable because it provides a more intuitive experience for users and can help ensure correct
application behavior.</p><ul><li>The Account Query Service applies events to build every version for every account.</li><li>Each account instance contains a version number, facilitating account-wise pagination queries
for change history.</li><li>The versioned accounts are replicated to a data warehouse like BigQuery(an enterprise data
warehouse product of Google) for OLAP analysis.</li></ul><p><strong>Kafka Connector</strong></p><p>The events are published to Kafka for downstream systems to subscribe from.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/Auticuro/docs/Design/Design Decisions"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Design Decisions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Auticuro/docs/Design/Command Side"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Command Side</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#command-side" class="table-of-contents__link toc-highlight">Command Side</a></li><li><a href="#query-side" class="table-of-contents__link toc-highlight">Query Side</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Auticuro, Airwallex. Built with Docusaurus.</div></div></div></footer></div>
<script src="/Auticuro/assets/js/runtime~main.db8b443a.js"></script>
<script src="/Auticuro/assets/js/main.e77f3fff.js"></script>
</body>
</html>